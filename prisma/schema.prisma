generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Thread {
  id             String         @id @default(uuid())
  conversationId String         @unique @map("conversation_id") @db.VarChar(50)
  authorUsername String         @map("author_username") @db.VarChar(100)
  authorName     String?        @map("author_name") @db.VarChar(255)
  tweetCount     Int            @map("tweet_count")
  collectedAt    DateTime       @default(now()) @map("collected_at")
  firstTweetUrl  String         @map("first_tweet_url")
  firstTweetDate DateTime?      @map("first_tweet_date")
  downloadCount  Int            @default(0) @map("download_count")
  seriesThreads  SeriesThread[]
  tweets         Tweet[]
  userSaves      UserSave[]

  @@index([conversationId])
  @@index([authorUsername])
  @@index([collectedAt(sort: Desc)])
  @@map("threads")
}

model Tweet {
  id              BigInt            @id
  threadId        String            @map("thread_id")
  content         String
  createdAt       DateTime          @map("created_at")
  authorUsername  String            @map("author_username") @db.VarChar(100)
  replyToId       BigInt?           @map("reply_to_id")
  retweetCount    Int               @default(0) @map("retweet_count")
  likeCount       Int               @default(0) @map("like_count")
  mediaUrls       String[]          @map("media_urls")
  sequenceNumber  Int               @map("sequence_number")
  bookmarks       Bookmark[]
  readingProgress ReadingProgress[]
  thread          Thread            @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, sequenceNumber])
  @@map("tweets")
}

model Series {
  id              String            @id @default(uuid())
  authorUsername  String            @map("author_username") @db.VarChar(100)
  title           String            @db.VarChar(255)
  description     String?
  coverImageUrl   String?           @map("cover_image_url")
  status          String            @default("ongoing") @db.VarChar(20)
  totalTweets     Int               @default(0) @map("total_tweets")
  totalThreads    Int               @default(0) @map("total_threads")
  totalViews      Int               @default(0) @map("total_views")
  slug            String            @unique @db.VarChar(255)
  isPublic        Boolean           @default(true) @map("is_public")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  analytics       Analytics[]
  bookmarks       Bookmark[]
  readingProgress ReadingProgress[]
  seriesThreads   SeriesThread[]
  seriesViews     SeriesView[]

  @@index([slug])
  @@index([authorUsername])
  @@index([isPublic, updatedAt(sort: Desc)])
  @@map("series")
}

model SeriesThread {
  id             String   @id @default(uuid())
  seriesId       String   @map("series_id")
  threadId       String   @map("thread_id")
  sequenceNumber Int      @map("sequence_number")
  addedAt        DateTime @default(now()) @map("added_at")
  series         Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  thread         Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([seriesId, threadId])
  @@unique([seriesId, sequenceNumber])
  @@index([seriesId, sequenceNumber])
  @@map("series_threads")
}

model ReadingProgress {
  id                 String   @id @default(uuid())
  sessionId          String   @map("session_id") @db.VarChar(255)
  seriesId           String   @map("series_id")
  lastReadTweetId    BigInt?  @map("last_read_tweet_id")
  progressPercentage Int?     @map("progress_percentage")
  updatedAt          DateTime @updatedAt @map("updated_at")
  lastReadTweet      Tweet?   @relation(fields: [lastReadTweetId], references: [id])
  series             Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([sessionId, seriesId])
  @@index([sessionId])
  @@map("reading_progress")
}

model Bookmark {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id") @db.VarChar(255)
  seriesId  String   @map("series_id")
  tweetId   BigInt   @map("tweet_id")
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  series    Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  tweet     Tweet    @relation(fields: [tweetId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt(sort: Desc)])
  @@index([seriesId, createdAt(sort: Desc)])
  @@map("bookmarks")
}

model SeriesView {
  id        String   @id @default(uuid())
  seriesId  String   @map("series_id")
  sessionId String?  @map("session_id") @db.VarChar(255)
  viewedAt  DateTime @default(now()) @map("viewed_at")
  series    Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@index([seriesId, viewedAt])
  @@map("series_views")
}

model UserSave {
  id        String   @id @default(uuid())
  sessionId String?  @map("session_id") @db.VarChar(255)
  threadId  String   @map("thread_id")
  savedAt   DateTime @default(now()) @map("saved_at")
  format    String   @default("markdown") @db.VarChar(20)
  thread    Thread   @relation(fields: [threadId], references: [id])

  @@index([sessionId, savedAt(sort: Desc)])
  @@map("user_saves")
}

model Analytics {
  id        Int      @id @default(autoincrement())
  eventType String   @map("event_type") @db.VarChar(50)
  threadId  String?  @map("thread_id")
  seriesId  String?  @map("series_id")
  format    String?  @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")
  series    Series?  @relation(fields: [seriesId], references: [id])

  @@index([eventType, createdAt])
  @@map("analytics")
}
