// í†µí•© ìŠ¤í‚¤ë§ˆ: ThreadSaver + NovelMind
// ThreadSaver: íŠ¸ìœ„í„° íƒ€ë˜ ì•„ì¹´ì´ë¸Œ
// NovelMind: AI ê¸°ë°˜ ì†Œì„¤ ì°½ì‘ ë„ìš°ë¯¸

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ThreadSaver ê¸°ì¡´ í…Œì´ë¸”
// ============================================

model Thread {
  id             String         @id @default(uuid())
  conversationId String         @unique @map("conversation_id") @db.VarChar(50)
  authorUsername String         @map("author_username") @db.VarChar(100)
  authorName     String?        @map("author_name") @db.VarChar(255)
  tweetCount     Int            @map("tweet_count")
  collectedAt    DateTime       @default(now()) @map("collected_at")
  firstTweetUrl  String         @map("first_tweet_url")
  firstTweetDate DateTime?      @map("first_tweet_date")
  downloadCount  Int            @default(0) @map("download_count")
  seriesThreads  SeriesThread[]
  tweets         Tweet[]
  userSaves      UserSave[]

  @@index([conversationId])
  @@index([authorUsername])
  @@index([collectedAt(sort: Desc)])
  @@map("threads")
}

model Tweet {
  id              BigInt            @id
  threadId        String            @map("thread_id")
  content         String
  createdAt       DateTime          @map("created_at")
  authorUsername  String            @map("author_username") @db.VarChar(100)
  replyToId       BigInt?           @map("reply_to_id")
  retweetCount    Int               @default(0) @map("retweet_count")
  likeCount       Int               @default(0) @map("like_count")
  mediaUrls       String[]          @map("media_urls")
  sequenceNumber  Int               @map("sequence_number")
  bookmarks       Bookmark[]
  readingProgress ReadingProgress[]
  thread          Thread            @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, sequenceNumber])
  @@map("tweets")
}

model Series {
  id              String            @id @default(uuid())
  authorUsername  String            @map("author_username") @db.VarChar(100)
  title           String            @db.VarChar(255)
  description     String?
  coverImageUrl   String?           @map("cover_image_url")
  status          String            @default("ongoing") @db.VarChar(20)
  totalTweets     Int               @default(0) @map("total_tweets")
  totalThreads    Int               @default(0) @map("total_threads")
  totalViews      Int               @default(0) @map("total_views")
  slug            String            @unique @db.VarChar(255)
  isPublic        Boolean           @default(true) @map("is_public")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  analytics       Analytics[]
  bookmarks       Bookmark[]
  readingProgress ReadingProgress[]
  seriesThreads   SeriesThread[]
  seriesViews     SeriesView[]

  // ğŸ”— NovelMind í†µí•©: Series â†’ Project ì—°ê²°
  novelProjects   SeriesProject[]

  @@index([slug])
  @@index([authorUsername])
  @@index([isPublic, updatedAt(sort: Desc)])
  @@map("series")
}

model SeriesThread {
  id             String   @id @default(uuid())
  seriesId       String   @map("series_id")
  threadId       String   @map("thread_id")
  sequenceNumber Int      @map("sequence_number")
  addedAt        DateTime @default(now()) @map("added_at")
  series         Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  thread         Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([seriesId, threadId])
  @@unique([seriesId, sequenceNumber])
  @@index([seriesId, sequenceNumber])
  @@map("series_threads")
}

model ReadingProgress {
  id                 String   @id @default(uuid())
  sessionId          String   @map("session_id") @db.VarChar(255)
  seriesId           String   @map("series_id")
  lastReadTweetId    BigInt?  @map("last_read_tweet_id")
  progressPercentage Int?     @map("progress_percentage")
  updatedAt          DateTime @updatedAt @map("updated_at")
  lastReadTweet      Tweet?   @relation(fields: [lastReadTweetId], references: [id])
  series             Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@unique([sessionId, seriesId])
  @@index([sessionId])
  @@map("reading_progress")
}

model Bookmark {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id") @db.VarChar(255)
  seriesId  String   @map("series_id")
  tweetId   BigInt   @map("tweet_id")
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  series    Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  tweet     Tweet    @relation(fields: [tweetId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt(sort: Desc)])
  @@index([seriesId, createdAt(sort: Desc)])
  @@map("bookmarks")
}

model SeriesView {
  id        String   @id @default(uuid())
  seriesId  String   @map("series_id")
  sessionId String?  @map("session_id") @db.VarChar(255)
  viewedAt  DateTime @default(now()) @map("viewed_at")
  series    Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@index([seriesId, viewedAt])
  @@map("series_views")
}

model UserSave {
  id        String   @id @default(uuid())
  sessionId String?  @map("session_id") @db.VarChar(255)
  threadId  String   @map("thread_id")
  savedAt   DateTime @default(now()) @map("saved_at")
  format    String   @default("markdown") @db.VarChar(20)
  thread    Thread   @relation(fields: [threadId], references: [id])

  @@index([sessionId, savedAt(sort: Desc)])
  @@map("user_saves")
}

model Analytics {
  id        Int      @id @default(autoincrement())
  eventType String   @map("event_type") @db.VarChar(50)
  threadId  String?  @map("thread_id")
  seriesId  String?  @map("series_id")
  format    String?  @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")
  series    Series?  @relation(fields: [seriesId], references: [id])

  @@index([eventType, createdAt])
  @@map("analytics")
}

// ============================================
// NovelMind í…Œì´ë¸”
// ============================================

model OriginalWork {
  id              String      @id @default(uuid())
  title           String
  mediaType       String      // anime, drama, game, idol, webtoon
  source          String      @default("Custom") // preset name or "Custom"
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  canonCharacters Character[] @relation("OriginalWorkCharacters")
  projects        Project[]
  worldRules      WorldRule[]

  @@map("original_works")
}

model Character {
  id             String        @id @default(uuid())
  name           String
  isCanon        Boolean       @default(true) // true: ì›ì‘ ìºë¦­í„°, false: ì˜¤ë¦¬ì§€ë„
  description    String?
  personality    String[]      // ["ëƒ‰ì² í•¨", "ì¸¤ë°ë ˆ"]
  appearance     String[]      // ["ê²€ì€ ë¨¸ë¦¬", "í‚¤ê°€ í¼"]
  abilities      String[]      // ["ë§ˆë²•", "ê²€ìˆ "]
  speechPatterns String[]      // ì˜ˆì‹œ ëŒ€ì‚¬
  relationships  Json?         // {"ìºë¦­í„°ID": "ê´€ê³„ì„¤ëª…"}
  originalWorkId String?
  projectId      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  originalWork   OriginalWork? @relation("OriginalWorkCharacters", fields: [originalWorkId], references: [id], onDelete: Cascade)
  project        Project?      @relation("ProjectCustomCharacters", fields: [projectId], references: [id], onDelete: Cascade)

  @@map("characters")
}

model WorldRule {
  id             String       @id @default(uuid())
  title          String
  description    String
  originalWorkId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  originalWork   OriginalWork @relation(fields: [originalWorkId], references: [id], onDelete: Cascade)

  @@map("world_rules")
}

model Project {
  id                 String       @id @default(uuid())
  title              String
  originalWorkId     String
  timelineSetting    String       // "ì‹œì¦Œ3 ì´í›„", "ê²°ë§ ì´í›„"
  auSettings         String[]     // ["í˜„ëŒ€ AU", "í•™ì›ë¬¼"]
  activeCharacterIds String[]     // í™œì„± ìºë¦­í„° ID ë°°ì—´
  tone               Json         // {atmosphere: "dark", pacing: "fast"}
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  customCharacters   Character[]  @relation("ProjectCustomCharacters")
  foreshadows        Foreshadow[]
  episodes           Episode[]
  originalWork       OriginalWork @relation(fields: [originalWorkId], references: [id])

  // ğŸ”— ThreadSaver í†µí•©: Project â† Series ì—°ê²°
  linkedSeries       SeriesProject?

  @@map("projects")
}

model Foreshadow {
  id             String   @id @default(uuid())
  title          String
  description    String
  status         String   // pending, active, resolved, discarded
  plantedAt      String?  // "3í™”"
  expectedPayoff String?  // "10í™” ì˜ˆì •"
  projectId      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("foreshadows")
}

model Episode {
  id        String        @id @default(uuid())
  title     String
  order     Int           @default(0)
  projectId String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  notes     EpisodeNote[]

  @@map("episodes")
}

model EpisodeNote {
  id        String   @id @default(uuid())
  content   String
  type      String   @default("General") // General, Dialogue, Plot, Draft
  order     Int      @default(0)
  episodeId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  episode   Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@map("episode_notes")
}

// ============================================
// ğŸ”— í†µí•© ë¸Œë¦¿ì§€ í…Œì´ë¸”
// ============================================

model SeriesProject {
  id                String   @id @default(uuid())
  seriesId          String   @unique @map("series_id")
  projectId         String   @unique @map("project_id")
  syncEnabled       Boolean  @default(true) @map("sync_enabled") // ìë™ ë™ê¸°í™” í™œì„±í™”
  lastSyncAt        DateTime? @map("last_sync_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  series            Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([seriesId])
  @@index([projectId])
  @@map("series_projects")
}
